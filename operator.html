<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Scoreboard Operator – EPL</title>
<style>
  :root {
    --center-bg: #ffffff;
    --score-bg: #f3f3f3;
    --home-bg: #111111;
    --away-bg: #111111;
    --accent-left: #a40606;
    --accent-right: #a40606;
  }

  * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  body {
    margin: 0;
    background: #111; 
    color: #f5f5f5;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 20px;
    gap: 16px;
  }

  h2 {
    margin: 0;
    margin-bottom: 8px;
  }

  .overlay-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  /* PREVIEW mirip index */
  .scoreboard-wrapper {
    position: relative;
    padding: 10px;
    border-radius: 12px;
    background: #050505;
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  .scoreboard {
    width: 1000px;
    max-width: 100%;
    aspect-ratio: 1984 / 600;
    background: transparent;
    overflow: hidden;
    border-radius: 10px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ffffff;
  }

  .bars-wrapper {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 1984px;
    height: 200px;
    transform: translate(-50%, -50%);
    pointer-events: none;
    display: flex;
    justify-content: space-between;
  }

  .bar-left,
  .bar-right {
    width: 972px;
    height: 200px;
  }

  .bar-left {
    background: linear-gradient(to right, rgba(91,37,37,0) 0%, var(--accent-left) 100%);
  }

  .bar-right {
    background: linear-gradient(to left, rgba(91,37,37,0) 0%, var(--accent-right) 100%);
  }

  .epl-logo {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 180px;
    height: auto;
    z-index: 3;
  }

  .epl-logo img {
    width: 100%;
    height: auto;
    display: block;
  }

  .team-name-preview {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 68px;
    font-weight: 700;
    z-index: 2;
    white-space: nowrap;
  }

  .team-left {
    left: 120px;
  }

  .team-right {
    right: 120px;
  }

  .score {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 180px;
    font-weight: 800;
    padding: 8px 18px;
    border-radius: 18px;
    background: transparent;
    color: #ffffff;
  }

  .score-left {
    left: 50%;
    transform: translate(calc(-50% - 160px), -50%);
  }

  .score-right {
    left: 50%;
    transform: translate(calc(-50% + 160px), -50%);
  }

  .time-panel {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: #ffffff;
    color: #111111;
    padding: 4px 18px;
    border-radius: 10px;
    font-size: 42px;
    font-weight: 700;
    z-index: 5;
  }

  /* PANEL KONTROL (gaya seperti 1operator) */
  .controls {
    width: 860px;
    max-width: 100%;
    background: rgba(24,24,24,0.95);
    border-radius: 8px;
    padding: 12px 16px;
    color: #eee;
    display: flex;
    flex-direction: column;
    gap: 10px;
    font-size: 13px;
  }

  .controls-section {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 14px;
    align-items: center;
  }

  .controls-section label {
    min-width: 105px;
    font-weight: 600;
    font-size: 12px;
  }

  .btn {
    padding: 4px 10px;
    border-radius: 999px;
    border: none;
    background: #ffffff25;
    color: #fff;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
  }

  .btn:hover {
    background: #ffffff40;
  }

  .btn-main {
    background: #00a884;
  }

  .btn-main:hover {
    background: #00c29b;
  }

  input[type="color"],
  input[type="number"],
  input[type="text"] {
    border: none;
    border-radius: 6px;
    font-size: 12px;
  }

  input[type="number"],
  input[type="text"] {
    background: #2a2a2a;
    color: #fff;
    padding: 4px 6px;
  }

  input[type="number"] {
    width: 60px;
  }

  input[type="text"] {
    width: 220px;
  }

  .tiny-label {
    font-size: 11px;
    opacity: 0.8;
  }

  .status {
    font-size: 12px;
    margin-left: 8px;
  }
</style>
</head>
<body>

<h2>⚽ Operator Panel – EPL Scoreboard</h2>

<div class="overlay-container">

  <!-- PREVIEW SCOREBOARD -->
  <div class="scoreboard-wrapper">
    <div class="scoreboard">
      <div class="bars-wrapper">
        <div class="bar-left"></div>
        <div class="bar-right"></div>
      </div>
      <div class="time-panel" id="timePreview">00:00</div>
      <div class="epl-logo">
        <img src="logo/logo-epl.svg" alt="Premier League"/>
      </div>
      <div class="score score-left" id="homeScorePreview">0</div>
      <div class="score score-right" id="awayScorePreview">0</div>
      <div class="team-name-preview team-left" id="teamLeftPreview">MAN</div>
      <div class="team-name-preview team-right" id="teamRightPreview">WHU</div>
    </div>
  </div>

  <!-- PANEL KONTROL -->
<div class="controls">

    <div class="controls-section">
      <label>Team Left</label>
      <input id="teamLeft" type="text" placeholder="MAN" oninput="handleChange()" />
    </div>

    <div class="controls-section">
      <label>Team Right</label>
      <input id="teamRight" type="text" placeholder="WHU" oninput="handleChange()" />
    </div>

    <div class="controls-section">
      <label>Score & Goal</label>
      <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
        <span class="tiny-label">Left</span>
        <button class="btn" onclick="changeScore('left', -1)">-</button>
        <input id="scoreLeft" type="number" value="0" oninput="handleChange()" />
        <button class="btn" onclick="changeScore('left', 1)">+</button>
        <button class="btn btn-main" onclick="triggerGoal('left')">GOAL L +1</button>
      </div>
      <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
        <span class="tiny-label">Right</span>
        <button class="btn" onclick="changeScore('right', -1)">-</button>
        <input id="scoreRight" type="number" value="0" oninput="handleChange()" />
        <button class="btn" onclick="changeScore('right', 1)">+</button>
        <button class="btn btn-main" onclick="triggerGoal('right')">GOAL R +1</button>
      </div>
      <div style="display:flex; gap:10px; align-items:center; margin-top:4px;">
        <span class="tiny-label">Durasi goal (detik)</span>
        <input id="goalDuration" type="number" value="4" min="1" max="10" style="width:70px" />
      </div>
    </div>

    <div class="controls-section">
      <label>Accent Gradient</label>
      <span class="tiny-label">Left</span>
      <input id="scoreLeftColor" type="color" value="#a40606" onchange="handleChange()" />
      <span class="tiny-label">Right</span>
      <input id="scoreRightColor" type="color" value="#a40606" onchange="handleChange()" />
      <span class="tiny-label">gradient tetap transparan</span>
    </div>

    <div class="controls-section">
      <label>Time</label>
      <input id="timeMinute" type="number" min="0" max="120" value="0" style="width:70px" oninput="handleChange()" /> :
      <input id="timeSecond" type="number" min="0" max="59" value="0" style="width:70px" oninput="handleChange()" />
      <span class="tiny-label">format otomatis mm:ss</span>
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
        <button class="btn btn-main" onclick="toggleTimer()">Start/Pause</button>
        <button class="btn" onclick="resetTimer()">Reset</button>
        <span class="tiny-label" id="timerState"></span>
      </div>
    </div>

    <div class="controls-section">
      <label>Overlay</label>
      <button class="btn" onclick="toggleOverlay()">Hide / Unhide + Replay</button>
      <span id="visibilityState" class="status"></span>
    </div>

    <div class="controls-section" style="justify-content:flex-end;">
      <span id="status" class="status"></span>
    </div>

  </div>
</div>

<script>
  let visibleState = true;
  let isCoolingDown = false;
  let lastPayloadKey = "";
  let pendingSync;
  let timerInterval = null;
  let timerRunning = false;
  let firstSyncSent = false;
  const COOLDOWN_MS = 900;
  const SYNC_DELAY = 250;

  function changeScore(side, delta) {
    const input = document.getElementById(
      side === "left" ? "scoreLeft" : "scoreRight"
    );
    let value = parseInt(input.value || "0", 10);
    value += delta;
    if (value < 0) value = 0;
    input.value = value;
    handleChange();
  }

  function handleChange() {
    updatePreview();
    scheduleSync();
  }

  function updatePreview() {
    const teamLeft = document.getElementById("teamLeft").value.trim() || "MAN";
    const teamRight = document.getElementById("teamRight").value.trim() || "WHU";
    const scoreLeft = document.getElementById("scoreLeft").value || "0";
    const scoreRight = document.getElementById("scoreRight").value || "0";
    const mm = Math.max(0, parseInt(document.getElementById("timeMinute").value || "0", 10));
    const ssRaw = parseInt(document.getElementById("timeSecond").value || "0", 10);
    const ss = Math.min(59, Math.max(0, isNaN(ssRaw) ? 0 : ssRaw));
    const time = `${String(mm).padStart(2, "0")}:${String(ss).padStart(2, "0")}`;
    document.getElementById("timeSecond").value = ss;
    const colorLeft = document.getElementById("scoreLeftColor").value || "#a40606";
    const colorRight = document.getElementById("scoreRightColor").value || "#a40606";

    // update preview team name
    document.getElementById("teamLeftPreview").textContent = teamLeft;
    document.getElementById("teamRightPreview").textContent = teamRight;

    // update preview score
    document.getElementById("homeScorePreview").textContent = scoreLeft;
    document.getElementById("awayScorePreview").textContent = scoreRight;

    // update preview time
    document.getElementById("timePreview").textContent = time;

    // update preview colors
    const board = document.querySelector(".scoreboard");
    board?.style.setProperty("--accent-left", colorLeft);
    board?.style.setProperty("--accent-right", colorRight);
  }

  function buildPayload(extra = {}) {
    return {
      teamLeft: document.getElementById("teamLeft").value.trim(),
      teamRight: document.getElementById("teamRight").value.trim(),
      scoreLeft: document.getElementById("scoreLeft").value,
      scoreRight: document.getElementById("scoreRight").value,
      scoreLeftColor: document.getElementById("scoreLeftColor").value,
      scoreRightColor: document.getElementById("scoreRightColor").value,
      time: `${String(document.getElementById("timeMinute").value || "0").padStart(2, "0")}:${String(document.getElementById("timeSecond").value || "0").padStart(2, "0")}`,
      visible: visibleState,
      ...extra,
    };
  }

  function scheduleSync(extra, options = {}) {
    clearTimeout(pendingSync);
    const payload = buildPayload(extra);
    pendingSync = setTimeout(() => {
      sendUpdate(payload, {
        skipDedup: !!extra,
        allowDuringCooldown: options.allowDuringCooldown,
      });
    }, SYNC_DELAY);
  }

  async function sendUpdate(customPayload, options = {}) {
    const statusEl = document.getElementById("status");
    const payload = customPayload || buildPayload();
    const payloadKey = JSON.stringify(payload);
    const skipDedup = options.skipDedup || payload.eventType === "goal" || payload.replayEntrance;

    if (!firstSyncSent) {
      firstSyncSent = true;
    } else if (!skipDedup && payloadKey === lastPayloadKey) {
      statusEl.textContent = "Belum ada perubahan (tidak dikirim).";
      statusEl.style.color = "#cccccc";
      return;
    }

    if (isCoolingDown && !options.allowDuringCooldown) {
      statusEl.textContent = "Tunggu sebentar biar tidak spam.";
      statusEl.style.color = "#cccccc";
      return;
    }

    statusEl.textContent = "Mengirim...";
    statusEl.style.color = "#cccccc";
    isCoolingDown = true;
    setTimeout(() => {
      isCoolingDown = false;
    }, COOLDOWN_MS);

    try {
      const res = await fetch("/.netlify/functions/pusher-update", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      });

      const json = await res.json().catch(() => ({}));

      if (!res.ok) {
        statusEl.textContent = "Gagal kirim: " + (json.error || res.status);
        statusEl.style.color = "#ff6b6b";
        return;
      }

      lastPayloadKey = payloadKey;
      statusEl.textContent = "Terkirim!";
      statusEl.style.color = "#00ff99";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error network / CORS";
      statusEl.style.color = "#ff6b6b";
    }
  }

  function toggleOverlay() {
    visibleState = !visibleState;
    document.getElementById("visibilityState").textContent = visibleState ? "Tampil" : "Sembunyi";
    sendUpdate(buildPayload({ replayEntrance: true }));
  }

  function triggerGoal(side) {
    changeScore(side, 1);
    const duration = parseInt(document.getElementById("goalDuration").value, 10) || 4;
    const payload = buildPayload({
      eventType: "goal",
      goalSide: side,
      goalDuration: duration,
    });
    sendUpdate(payload, { skipDedup: true });
  }

  function toggleTimer() {
    if (timerRunning) {
      pauseTimer();
    } else {
      startTimer();
    }
  }

  function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    document.getElementById("timerState").textContent = "⏱ Running";
    timerInterval = setInterval(tickTimer, 1000);
  }

  function pauseTimer() {
    timerRunning = false;
    document.getElementById("timerState").textContent = "⏸ Paused";
    clearInterval(timerInterval);
    timerInterval = null;
  }

  function resetTimer() {
    document.getElementById("timeMinute").value = 0;
    document.getElementById("timeSecond").value = 0;
    handleChange();
    pauseTimer();
    document.getElementById("timerState").textContent = "Reset";
  }

  function tickTimer() {
    const minuteEl = document.getElementById("timeMinute");
    const secondEl = document.getElementById("timeSecond");
    let mm = parseInt(minuteEl.value || "0", 10);
    let ss = parseInt(secondEl.value || "0", 10);

    ss += 1;
    if (ss >= 60) {
      ss = 0;
      mm += 1;
    }

    minuteEl.value = mm;
    secondEl.value = ss;
    updatePreview();
    scheduleSync({}, { allowDuringCooldown: true });
  }

  // set awal preview sesuai default input
  updatePreview();
  document.getElementById("visibilityState").textContent = "Tampil";
  document.getElementById("timerState").textContent = "⏸ Paused";
  scheduleSync();
</script>

</body>
</html>
