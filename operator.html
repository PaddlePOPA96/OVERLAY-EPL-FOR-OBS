<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Scoreboard Operator – EPL</title>
<style>
  :root {
    --center-bg: #ffffff;
    --score-bg: #f3f3f3;
    --home-bg: #111111;
    --away-bg: #111111;
  }

  * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  body {
    margin: 0;
    background: #111; 
    color: #f5f5f5;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 20px;
    gap: 16px;
  }

  h2 {
    margin: 0;
    margin-bottom: 8px;
  }

  .overlay-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  /* PREVIEW SCOREBOARD (diambil gaya dari 1operator.html) */
  .scoreboard-wrapper {
    position: relative;
    padding: 10px;
    border-radius: 12px;
    background: linear-gradient(90deg, var(--home-bg) 0 50%, var(--away-bg) 50% 100%);
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  .scoreboard {
    width: 860px;
    max-width: 100%;
    aspect-ratio: 16 / 5;
    background: #000;
    display: grid;
    grid-template-columns: 2fr 1.8fr 1.8fr;
    overflow: hidden;
    border-radius: 8px;
    position: relative;
  }

  .time-panel {
    display: grid;
    grid-template-rows: 1fr 1fr;
  }

  .time-top {
    background: #004535;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 800;
    font-size: 32px;
  }

  .time-bottom {
    background: #f8f8f8;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    font-weight: 700;
    color: #111;
  }

  .teams-panel {
    background: var(--center-bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    position: relative;
  }

  .teams-panel::before {
    content: "";
    position: absolute;
    right: 0;
    top: 20%;
    bottom: 20%;
    width: 8px;
    background: #ff4b4b;
  }

  .team-logo {
    width: 90px;
    height: 90px;
    object-fit: contain;
    filter: drop-shadow(0 0 8px rgba(0,0,0,0.4));
  }

  .score-panel {
    display: grid;
    grid-template-rows: 1fr 1fr;
  }

  .score-row {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px;
    font-weight: 700;
  }

  .score-row.home-row {
    background: #ff4b4b;
    color: #fff;
  }

  .score-row.away-row {
    background: #e5e5e5;
    color: #000;
    position: relative;
  }

  .score-row.away-row::before {
    content: "";
    position: absolute;
    top: 0;
    left: 12%;
    right: 12%;
    height: 3px;
    background: #000;
  }

  .team-name-preview {
    position: absolute;
    top: 8px;
    left: 12px;
    right: 12px;
    display: flex;
    justify-content: space-between;
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 0 4px rgba(0,0,0,0.8);
  }

  /* PANEL KONTROL (gaya seperti 1operator) */
  .controls {
    width: 860px;
    max-width: 100%;
    background: rgba(24,24,24,0.95);
    border-radius: 8px;
    padding: 12px 16px;
    color: #eee;
    display: flex;
    flex-direction: column;
    gap: 10px;
    font-size: 13px;
  }

  .controls-section {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 14px;
    align-items: center;
  }

  .controls-section label {
    min-width: 105px;
    font-weight: 600;
    font-size: 12px;
  }

  .btn {
    padding: 4px 10px;
    border-radius: 999px;
    border: none;
    background: #ffffff25;
    color: #fff;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
  }

  .btn:hover {
    background: #ffffff40;
  }

  .btn-main {
    background: #00a884;
  }

  .btn-main:hover {
    background: #00c29b;
  }

  input[type="color"],
  input[type="number"],
  input[type="text"] {
    border: none;
    border-radius: 6px;
    font-size: 12px;
  }

  input[type="number"],
  input[type="text"] {
    background: #2a2a2a;
    color: #fff;
    padding: 4px 6px;
  }

  input[type="number"] {
    width: 60px;
  }

  input[type="text"] {
    width: 220px;
  }

  .tiny-label {
    font-size: 11px;
    opacity: 0.8;
  }

  .status {
    font-size: 12px;
    margin-left: 8px;
  }
</style>
</head>
<body>

<h2>⚽ Operator Panel – EPL Scoreboard</h2>

<div class="overlay-container">

  <!-- PREVIEW SCOREBOARD -->
  <div class="scoreboard-wrapper">
    <div class="scoreboard">
      <div class="time-panel">
        <div class="time-top">CHECKVAR</div>
        <div class="time-bottom" id="timePreview">00:00</div>
      </div>

      <div class="teams-panel">
        <div class="team-name-preview">
          <span id="teamLeftPreview">MAN</span>
          <span id="teamRightPreview">WHU</span>
        </div>
        <img id="homeLogo" class="team-logo"
             src="https://upload.wikimedia.org/wikipedia/id/thumb/0/0c/Liverpool_FC.svg/370px-Liverpool_FC.svg.png"/>
        <img id="awayLogo" class="team-logo"
             src="https://upload.wikimedia.org/wikipedia/id/thumb/e/eb/Manchester_City_FC_badge.svg/400px-Manchester_City_FC_badge.svg.png"/>
      </div>

      <div class="score-panel">
        <div class="score-row home-row"><span id="homeScorePreview">0</span></div>
        <div class="score-row away-row"><span id="awayScorePreview">0</span></div>
      </div>
    </div>
  </div>

  <!-- PANEL KONTROL -->
<div class="controls">

    <div class="controls-section">
      <label>Team Left</label>
      <input id="teamLeft" type="text" placeholder="MAN" oninput="updatePreview()" />
    </div>

    <div class="controls-section">
      <label>Team Right</label>
      <input id="teamRight" type="text" placeholder="WHU" oninput="updatePreview()" />
    </div>

    <div class="controls-section">
      <label>Score Left</label>
      <button class="btn" onclick="changeScore('left', -1)">-</button>
      <input id="scoreLeft" type="number" value="0" oninput="updatePreview()" />
      <button class="btn" onclick="changeScore('left', 1)">+</button>
    </div>

    <div class="controls-section">
      <label>Score Right</label>
      <button class="btn" onclick="changeScore('right', -1)">-</button>
      <input id="scoreRight" type="number" value="0" oninput="updatePreview()" />
      <button class="btn" onclick="changeScore('right', 1)">+</button>
    </div>

    <div class="controls-section">
      <label>Color Score Left</label>
      <input id="scoreLeftColor" type="color" value="#ffffff" onchange="updatePreview()" />
      <label>Color Right</label>
      <input id="scoreRightColor" type="color" value="#ffffff" onchange="updatePreview()" />
    </div>

    <div class="controls-section">
      <label>Time</label>
      <input id="matchTime" type="text" placeholder="00:00" oninput="updatePreview()" />
      <span class="tiny-label">Bisa 00:00 atau 45+3, dll (hanya tampilan).</span>
    </div>

    <div class="controls-section">
      <label>Logo Home URL</label>
      <input id="homeLogoInput" type="text" placeholder="https://..."
             onblur="setLogoFromLink('home', this.value)" />
    </div>

    <div class="controls-section">
      <label>Logo Away URL</label>
      <input id="awayLogoInput" type="text" placeholder="https://..."
             onblur="setLogoFromLink('away', this.value)" />
    </div>

    <div class="controls-section">
      <label>Overlay</label>
      <button class="btn" onclick="setVisibility(false)">Hide</button>
      <button class="btn" onclick="setVisibility(true)">Unhide</button>
      <span id="visibilityState" class="status"></span>
    </div>

    <div class="controls-section">
      <label>Goal + Anim</label>
      <button class="btn btn-main" onclick="triggerGoal('left')">GOAL LEFT +1</button>
      <button class="btn btn-main" onclick="triggerGoal('right')">GOAL RIGHT +1</button>
      <input id="goalDuration" type="number" value="4" min="1" max="10" style="width:70px" />
      <span class="tiny-label">durasi animasi (detik)</span>
    </div>

    <div class="controls-section">
      <label>Kirim</label>
      <button class="btn btn-main" onclick="sendUpdate()">KIRIM KE OVERLAY</button>
      <span id="status" class="status"></span>
    </div>

  </div>
</div>

<script>
  let visibleState = true;
  let isCoolingDown = false;
  let lastPayloadKey = "";
  const COOLDOWN_MS = 900;

  function changeScore(side, delta) {
    const input = document.getElementById(
      side === "left" ? "scoreLeft" : "scoreRight"
    );
    let value = parseInt(input.value || "0", 10);
    value += delta;
    if (value < 0) value = 0;
    input.value = value;
    updatePreview();
  }

  function updatePreview() {
    const teamLeft = document.getElementById("teamLeft").value.trim() || "MAN";
    const teamRight = document.getElementById("teamRight").value.trim() || "WHU";
    const scoreLeft = document.getElementById("scoreLeft").value || "0";
    const scoreRight = document.getElementById("scoreRight").value || "0";
    const time = document.getElementById("matchTime").value.trim() || "00:00";
    const colorLeft = document.getElementById("scoreLeftColor").value || "#ffffff";
    const colorRight = document.getElementById("scoreRightColor").value || "#ffffff";

    // update preview team name
    document.getElementById("teamLeftPreview").textContent = teamLeft;
    document.getElementById("teamRightPreview").textContent = teamRight;

    // update preview score
    document.getElementById("homeScorePreview").textContent = scoreLeft;
    document.getElementById("awayScorePreview").textContent = scoreRight;

    // update preview time
    document.getElementById("timePreview").textContent = time;

    // update preview colors
    document.querySelector(".score-row.home-row").style.color = colorLeft;
    document.querySelector(".score-row.away-row").style.color = colorRight;
  }

  function setLogoFromLink(team, url) {
    if (!url) return;
    if (team === "home") {
      document.getElementById("homeLogo").src = url;
    } else {
      document.getElementById("awayLogo").src = url;
    }
  }

  function buildPayload(extra = {}) {
    return {
      teamLeft: document.getElementById("teamLeft").value.trim(),
      teamRight: document.getElementById("teamRight").value.trim(),
      scoreLeft: document.getElementById("scoreLeft").value,
      scoreRight: document.getElementById("scoreRight").value,
      scoreLeftColor: document.getElementById("scoreLeftColor").value,
      scoreRightColor: document.getElementById("scoreRightColor").value,
      time: document.getElementById("matchTime").value.trim(),
      visible: visibleState,
      ...extra,
    };
  }

  async function sendUpdate(customPayload, options = {}) {
    const statusEl = document.getElementById("status");
    const payload = customPayload || buildPayload();
    const payloadKey = JSON.stringify(payload);
    const skipDedup = options.skipDedup || payload.eventType === "goal";

    if (!skipDedup && payloadKey === lastPayloadKey) {
      statusEl.textContent = "Belum ada perubahan (tidak dikirim).";
      statusEl.style.color = "#cccccc";
      return;
    }

    if (isCoolingDown) {
      statusEl.textContent = "Tunggu sebentar biar tidak spam.";
      statusEl.style.color = "#cccccc";
      return;
    }

    statusEl.textContent = "Mengirim...";
    statusEl.style.color = "#cccccc";
    isCoolingDown = true;
    setTimeout(() => {
      isCoolingDown = false;
    }, COOLDOWN_MS);

    try {
      const res = await fetch("/.netlify/functions/pusher-update", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      });

      const json = await res.json().catch(() => ({}));

      if (!res.ok) {
        statusEl.textContent = "Gagal kirim: " + (json.error || res.status);
        statusEl.style.color = "#ff6b6b";
        return;
      }

      lastPayloadKey = payloadKey;
      statusEl.textContent = "Terkirim!";
      statusEl.style.color = "#00ff99";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error network / CORS";
      statusEl.style.color = "#ff6b6b";
    }
  }

  function setVisibility(show, shouldSend = true) {
    visibleState = !!show;
    document.getElementById("visibilityState").textContent = show ? "Tampil" : "Sembunyi";
    if (shouldSend) {
      sendUpdate(buildPayload());
    }
  }

  function triggerGoal(side) {
    changeScore(side, 1);
    const duration = parseInt(document.getElementById("goalDuration").value, 10) || 4;
    const payload = buildPayload({
      eventType: "goal",
      goalSide: side,
      goalDuration: duration,
    });
    sendUpdate(payload, { skipDedup: true });
  }

  // set awal preview sesuai default input
  updatePreview();
  setVisibility(true, false);
</script>

</body>
</html>
